<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pas si vite !</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
/* --- THEME PREMIUM : Gris sombre / ArgentÃ© --- */
:root{
    --bg:#111418;
    --panel:#191d22;
    --card:#20262d;
    --muted:#b8c3cf;
    --accent:#d0e2f7;
    --silver:#c0c7d1;
    --success:#9de6b1;
    --warning:#f7d772;
    --danger:#f28b82;
}

/* --- GLOBAL --- */
html,body{
    margin:0;
    padding:0;
    background:var(--bg);
    font-family:Inter,sans-serif;
    color:var(--muted);
    -webkit-font-smoothing:antialiased;
}

.wrap{
    max-width:900px;
    margin:30px auto;
    padding:28px;
    background:var(--panel);
    border-radius:26px;
    box-shadow:
        inset 0 0 12px rgba(255,255,255,0.03),
        0 12px 28px rgba(0,0,0,0.4);
}

h1{
    text-align:center;
    font-size:34px;
    font-weight:800;
    color:var(--accent);
    margin-bottom:10px;
}

/* Cards */
.card{
    display:flex;
    flex-direction:column;
    gap:26px;
}

.inputs, 
.result-card{
    background:var(--card);
    border-radius:22px;
    padding:22px;
    border:1px solid rgba(255,255,255,0.08);
    box-shadow:
        inset 0 1px 4px rgba(255,255,255,0.04),
        0 8px 18px rgba(0,0,0,0.35);
}

/* Labels / Inputs */
.row{
    display:flex;
    align-items:center;
    gap:14px;
    flex-wrap:wrap;
}

.label{
    width:260px;
    font-size:17px;
    font-weight:600;
    color:var(--silver);
}

input[type=number]{
    flex:1;
    min-width:140px;
    padding:14px 16px;
    background:#0f1419;
    border:1px solid rgba(255,255,255,0.08);
    border-radius:18px;
    text-align:center;
    font-size:18px;
    color:white;
    box-shadow:inset 0 2px 4px rgba(0,0,0,0.4);
    outline:none;
}

/* Bouton GPS + Signal */
.gps-line{
    margin-top:18px;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:16px;
}

.gps-btn{
    padding:12px 18px;
    font-size:16px;
    border-radius:14px;
    border:none;
    cursor:pointer;
    background:#2a333d;
    color:var(--silver);
}
.gps-btn.active{
    background:#44525e;
}

#gpsSignal{
    font-size:14px;
    font-weight:600;
    color:var(--silver);
}

/* TITRES + VALEURS */
.result-title{
    color:var(--accent);
    font-size:20px;
    font-weight:700;
    text-align:center;
}

.result-value{
    font-size:40px;
    font-weight:800;
    color:var(--success);
    text-align:center;
}

/* "plus tÃ´t" â†’ mÃªme style que result-title */
.result-sub{
    color:var(--accent);
    font-size:20px;
    font-weight:700;
    text-align:center;
    margin-top:5px;
}

/* FEU */
.risk-row{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:20px;
}

#trafficLight{
    width:70px;
}

#trafficLight rect{
    fill:#161b20;
    stroke:#2a3238;
    stroke-width:2;
    rx:10;
}

#trafficLight circle{
    r:10;
    opacity:0.35;
    transition:0.3s;
}

#lightGreen.active{ fill:#73e087!important; opacity:1; }
#lightYellow.active{ fill:#f7d772!important; opacity:1; }
#lightRed.active{ fill:#f28b82!important; opacity:1; }

.risk-col{
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    text-align:center;
    gap:12px;
}

#pointsValue{
    width:100%;
    padding:12px;
    border-radius:16px;
    background:rgba(255,255,255,0.03);
}

#pointsComment, #fineText{
    font-size:18px;
    font-weight:600;
    color:var(--silver);
}

/* Reset */
.reset-card{
    background:var(--card);
    padding:22px;
    border-radius:22px;
    border:1px solid rgba(255,255,255,0.08);
    display:flex;
    justify-content:center;
    align-items:center;
}

.reset-btn{
    background:linear-gradient(145deg,#252c33,#1b2026);
    color:var(--silver);
    padding:14px 34px;
    font-size:18px;
    border:none;
    border-radius:14px;
    cursor:pointer;
}
.reset-btn:hover{ background:#2d343c; }

</style>
</head>

<body>

<div class="wrap">
    <h1>ðŸš— Pas si vite !</h1>

    <div class="card">

        <!-- INPUTS -->
        <div class="inputs">
            <div class="row">
                <div class="label">Vitesse limitÃ©e Ã  [km/h]</div>
                <input id="b1" type="number" placeholder="ex. 50" />
            </div>

            <div class="row">
                <div class="label">Si je roule Ã  [km/h]</div>
                <input id="b2" type="number" placeholder="ex. 70" />
            </div>

            <div class="row">
                <div class="label">Sur une distance de [km]</div>
                <input id="b3" type="number" placeholder="ex. 3" />
            </div>

            <!-- GPS centered -->
            <div class="gps-line">
                <button id="gpsBtn" class="gps-btn">ðŸ“¡ Activer le GPS</button>
                <div id="gpsSignal">Signal GPS : â€”</div>
            </div>

        </div>

        <!-- TEMPS -->
        <div class="result-card">
            <div class="result-title">Alors j'arrive</div>
            <div id="b5" class="result-value">0 min 0 s</div>
            <div class="result-sub">plus tÃ´t</div>
        </div>

        <!-- RISQUE -->
        <div class="result-card">
            <div class="result-title">Risque supplÃ©mentaire estimÃ©</div>

            <div class="risk-row">

                <svg id="trafficLight" viewBox="0 0 40 90">
                    <rect x="5" y="5" width="30" height="80"/>
                    <circle id="lightRed" cx="20" cy="22" />
                    <circle id="lightYellow" cx="20" cy="45" />
                    <circle id="lightGreen" cx="20" cy="68" />
                </svg>

                <div class="risk-col">
                    <div id="riskValue" class="result-value"
                        style="background:#161b20;padding:8px 12px;border-radius:14px;">
                        0 %
                    </div>

                    <div class="result-sub">d'accident en plus</div>

                    <div id="pointsValue">
                        <div id="pointsComment">â€”</div>
                        <div id="fineText">â€”</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESET -->
        <div class="result-card reset-card">
            <button class="reset-btn" id="resetBtn">RÃ©initialiser</button>
        </div>

    </div>
</div>

<script>
/* -------------------------
    GPS + LIMITE + VITESSE
--------------------------*/

let gpsWatchId = null;

const gpsBtn = document.getElementById("gpsBtn");
const gpsSignal = document.getElementById("gpsSignal");

const b1 = document.getElementById("b1");
const b2 = document.getElementById("b2");
const b3 = document.getElementById("b3");

/* Indicateur de prÃ©cision GPS */
function updateGPSSignal(acc){
    if(acc > 50) gpsSignal.textContent = "Signal GPS : âŒ trÃ¨s faible";
    else if(acc > 20) gpsSignal.textContent = "Signal GPS : âš  faible";
    else if(acc > 10) gpsSignal.textContent = "Signal GPS : âœ“ moyen";
    else gpsSignal.textContent = "Signal GPS : ðŸŸ¢ fort";
}

/* API OSM Overpass */
async function fetchOSMSpeedLimit(lat, lng){
    const query = `
        [out:json][timeout:7];
        way(around:40,${lat},${lng})["highway"]["maxspeed"];
        out tags;
    `;

    try{
        const res = await fetch("https://overpass-api.de/api/interpreter", {
            method:"POST",
            body:query
        });
        const data = await res.json();

        if(data.elements.length){
            let max = data.elements[0].tags.maxspeed;

            if(max === "FR:urban") max = 50;
            if(max === "FR:rural") max = 80;
            if(max === "FR:motorway") max = 130;
            if(max === "FR:zone30") max = 30;

            const num = parseInt(max);
            return !isNaN(num) ? num : null;
        }
    }catch(e){
        console.error("OSM error", e);
    }
    return null;
}

/* Activation GPS */
gpsBtn.addEventListener("click", () => {

    if(gpsWatchId){ 
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;

        gpsBtn.textContent = "ðŸ“¡ Activer le GPS";
        gpsBtn.classList.remove("active");
        gpsSignal.textContent = "Signal GPS : â€”";

        b2.readOnly = false;
        b1.readOnly = false;

        return;
    }

    if(!navigator.geolocation){
        alert("GÃ©olocalisation non supportÃ©e.");
        return;
    }

    gpsBtn.textContent = "ðŸ“¡ GPS actif";
    gpsBtn.classList.add("active");

    b2.readOnly = true;
    b1.readOnly = true;

    gpsWatchId = navigator.geolocation.watchPosition(
        async (pos) => {
            updateGPSSignal(pos.coords.accuracy);

            /* VITESSE GPS */
            if(pos.coords.speed !== null){
                const kmh = Math.round(pos.coords.speed * 3.6);
                b2.value = kmh;
            }

            /* LIMITE AUTOMATIQUE */
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            const limit = await fetchOSMSpeedLimit(lat, lng);
            if(limit){
                b1.value = limit;
            }

            calculate();
        },
        (err) => {
            alert("Erreur GPS : " + err.message);
        },
        { enableHighAccuracy:true, maximumAge:300, timeout:7000 }
    );
});

/* -------------------------
    CALCULS
--------------------------*/

const out=document.getElementById('b5');
const riskBox=document.getElementById('riskValue');

const lightR=document.getElementById('lightRed');
const lightY=document.getElementById('lightYellow');
const lightG=document.getElementById('lightGreen');

const pointsComment=document.getElementById('pointsComment');
const fineText=document.getElementById('fineText');

function clearLights(){
    [lightR,lightY,lightG].forEach(l=>l.classList.remove("active"));
}

function setLight(state){
    clearLights();
    if(state==="green") lightG.classList.add("active");
    if(state==="yellow") lightY.classList.add("active");
    if(state==="red") lightR.classList.add("active");
}

function calculate(){

    const limit=parseFloat(b1.value);
    const speed=parseFloat(b2.value);
    const dist=parseFloat(b3.value);

    if(!limit || !speed || !dist || speed <= limit){
        out.textContent="0 min 0 s";
        riskBox.textContent="0 %";
        riskBox.style.color="var(--success)";
        pointsComment.textContent="â€”";
        fineText.textContent="â€”";
        clearLights();
        return;
    }

    const tL=dist/limit, tS=dist/speed;
    const diff=Math.round((tL-tS)*3600);
    const m=Math.max(0,Math.floor(diff/60));
    const s=Math.max(0,Math.abs(diff%60));

    out.textContent=`${m} min ${s} s`;

    const diffSpeed=Math.abs(speed-limit);
    const risk=Math.max(0,Math.round(diffSpeed*3));

    riskBox.textContent=risk+" %";

    /* Couleurs synchronisÃ©es avec les feux */
    if(risk < 10){ 
        riskBox.style.color="var(--success)";
        setLight("green"); 
    }
    else if(risk < 30){ 
        riskBox.style.color="var(--warning)";
        setLight("yellow"); 
    }
    else{ 
        riskBox.style.color="var(--danger)";
        setLight("red"); 
    }

    let pts = diffSpeed<5?0 : diffSpeed<20?1 : diffSpeed<30?2 :
              diffSpeed<40?3 : diffSpeed<50?4 : 6;

    pointsComment.textContent =
        `Pour gagner ${m} min ${s} s, vous perdez ${pts} point${pts>1?"s":""}.`;

    let amende=0;

    if(pts===0){ amende = (limit <= 50 ? 135 : 68); }
    else if(pts===1){ amende = 68; }
    else if(pts>=2 && pts<=4){ amende = 135; }
    else if(pts===6){ amende = 1500; }

    fineText.textContent = `Vous vous exposez Ã  une amende de ${amende} â‚¬`;
}

[b1,b2,b3].forEach(e=>e.addEventListener("input",calculate));

document.getElementById("resetBtn").addEventListener("click",()=>{
    b1.value=""; b2.value=""; b3.value="";
    out.textContent="0 min 0 s";
    riskBox.textContent="0 %";
    pointsComment.textContent="â€”";
    fineText.textContent="â€”";
    clearLights();
});

calculate();
</script>

</body>
</html>
